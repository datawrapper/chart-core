const path = require('path');
const fs = require('fs');
const { requireConfig } = require('@datawrapper/shared/node/findConfig');

const { general, plugins } = requireConfig();

const sveltePlugins = Object.entries(plugins)
    .filter(([, cfg]) => cfg.enabled && cfg.svelte)
    .map(([name, cfg]) => [
        name,
        {
            ...cfg,
            ...require(path.join(general.localPluginRoot, name, 'frontend.js'))
        }
    ]);

const afterBodyComponents = sveltePlugins
    .map(
        ([name, cfg]) =>
            `import ${cfg.afterBody.replace('.svelte', '')} from '${name}/${cfg.afterBody}'`
    )
    .join('\n');

const afterBodyModule = `/*
Warning: This file is automatically generated by 'scripts/generate-svelte-plugins.js'.
Do not edit it directly! You have been warned!
*/

${afterBodyComponents}
export default [${sveltePlugins
    .map(([, cfg]) => `[${[cfg.afterBody.replace('.svelte', ''), `'${cfg.key}'`].join(',')}]`)
    .join(',')}]`;

fs.writeFileSync(path.join(__dirname, '../lib/AfterBodyComponents.js'), afterBodyModule);
